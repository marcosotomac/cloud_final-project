# ============================================================================
# KFC ORDER MANAGEMENT SYSTEM - SERVERLESS CONFIGURATION
# Optimizado para AWS Academy LabRole (sin crear roles IAM)
# ============================================================================

service: kfc-core

provider:
  name: aws
  runtime: python3.11
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}

  # IAM - Usar LabRole existente de AWS Academy
  iam:
    role: arn:aws:iam::595645243021:role/LabRole

  # HTTP API con CORS global (menos recursos que REST API)
  httpApi:
    cors:
      allowedOrigins:
        - "*"
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Api-Key
        - X-Tenant-Id
      allowedMethods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS

  # Variables de entorno
  environment:
    STAGE: ${self:provider.stage}
    REGION: ${self:provider.region}
    ORDERS_TABLE: kfc-orders-${self:provider.stage}
    CONNECTIONS_TABLE: kfc-connections-${self:provider.stage}
    TENANTS_TABLE: kfc-tenants-${self:provider.stage}
    MENU_TABLE: kfc-menu-${self:provider.stage}
    USERS_TABLE: kfc-users-${self:provider.stage}
    INVENTORY_TABLE: kfc-inventory-${self:provider.stage}
    PROMOTIONS_TABLE: kfc-promotions-${self:provider.stage}
    CUSTOMERS_TABLE: kfc-customers-${self:provider.stage}
    ORDER_EVENTS_BUS: kfc-events-${self:provider.stage}
    ORDERS_QUEUE_URL: !Ref OrdersQueue
    NOTIFICATIONS_TOPIC_ARN: !Ref NotificationsTopic
    ASSETS_BUCKET: kfc-assets-${self:provider.stage}-595645243021

custom:
  pythonRequirements:
    dockerizePip: false
    slim: true
    noDeploy:
      - boto3
      - botocore

package:
  individually: false
  patterns:
    - "!node_modules/**"
    - "!.git/**"
    - "!.venv/**"
    - "!__pycache__/**"
    - "!*.md"
    - "!tests/**"
    - "src/**"

functions:
  # ==================== WEBSOCKET HANDLERS ====================
  wsConnect:
    handler: src/handlers/websocket.connect_handler
    events:
      - websocket:
          route: $connect

  wsDisconnect:
    handler: src/handlers/websocket.disconnect_handler
    events:
      - websocket:
          route: $disconnect

  wsDefault:
    handler: src/handlers/websocket.default_handler
    events:
      - websocket:
          route: $default

  wsSubscribe:
    handler: src/handlers/websocket.subscribe_handler
    events:
      - websocket:
          route: subscribe

  # ==================== AUTH ====================
  register:
    handler: src/handlers/auth.register_handler
    events:
      - httpApi:
          path: /auth/register
          method: post

  login:
    handler: src/handlers/auth.login_handler
    events:
      - httpApi:
          path: /auth/login
          method: post

  # ==================== TENANTS ====================
  createTenant:
    handler: src/handlers/tenants.create_tenant_handler
    events:
      - httpApi:
          path: /tenants
          method: post

  getTenants:
    handler: src/handlers/tenants.get_tenants_handler
    events:
      - httpApi:
          path: /tenants
          method: get

  getTenant:
    handler: src/handlers/tenants.get_tenant_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}
          method: get

  # ==================== MENU ====================
  createMenuItem:
    handler: src/handlers/menu.create_menu_item_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/menu
          method: post

  getMenu:
    handler: src/handlers/menu.get_menu_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/menu
          method: get

  updateMenuItem:
    handler: src/handlers/menu.update_menu_item_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/menu/{itemId}
          method: put

  deleteMenuItem:
    handler: src/handlers/menu.delete_menu_item_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/menu/{itemId}
          method: delete

  # ==================== UPLOADS ====================
  getUploadUrl:
    handler: src/handlers/uploads.get_upload_url_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/uploads/url
          method: get

  # ==================== ORDERS ====================
  createOrder:
    handler: src/handlers/orders.create_order_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders
          method: post

  getOrders:
    handler: src/handlers/orders.get_orders_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders
          method: get

  getOrder:
    handler: src/handlers/orders.get_order_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}
          method: get

  getOrdersByStatus:
    handler: src/handlers/orders.get_orders_by_status_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/status/{status}
          method: get

  updateOrder:
    handler: src/handlers/orders.update_order_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}
          method: put

  cancelOrder:
    handler: src/handlers/orders.cancel_order_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}/cancel
          method: post

  # ==================== WORKFLOW ====================
  takeOrder:
    handler: src/handlers/workflow.take_order_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}/workflow/take
          method: post

  startCooking:
    handler: src/handlers/workflow.start_cooking_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}/workflow/cook
          method: post

  finishCooking:
    handler: src/handlers/workflow.finish_cooking_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}/workflow/cooked
          method: post

  packOrder:
    handler: src/handlers/workflow.pack_order_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}/workflow/pack
          method: post

  startDelivery:
    handler: src/handlers/workflow.start_delivery_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}/workflow/deliver
          method: post

  completeDelivery:
    handler: src/handlers/workflow.complete_delivery_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}/workflow/complete
          method: post

  # ==================== DASHBOARD ====================
  getDashboard:
    handler: src/handlers/dashboard.get_dashboard_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/dashboard
          method: get

  getWorkflowStats:
    handler: src/handlers/dashboard.get_workflow_stats_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/dashboard/workflow-stats
          method: get

  # ==================== STAFF ====================
  getStaff:
    handler: src/handlers/staff.get_staff_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/staff
          method: get

  createStaff:
    handler: src/handlers/staff.create_staff_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/staff
          method: post

  updateStaff:
    handler: src/handlers/staff.update_staff_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/staff/{staffId}
          method: put

  getStaffMember:
    handler: src/handlers/staff.get_staff_member_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/staff/{staffId}
          method: get

  # ==================== INVENTORY ====================
  getInventory:
    handler: src/handlers/inventory.get_inventory_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/inventory
          method: get

  createInventoryItem:
    handler: src/handlers/inventory.create_inventory_item_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/inventory
          method: post

  updateInventoryItem:
    handler: src/handlers/inventory.update_inventory_item_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/inventory/{itemId}
          method: put

  adjustInventory:
    handler: src/handlers/inventory.adjust_inventory_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/inventory/{itemId}/adjust
          method: post

  getLowStockAlerts:
    handler: src/handlers/inventory.get_low_stock_alerts_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/inventory/alerts/low-stock
          method: get

  # ==================== PROMOTIONS ====================
  getPromotions:
    handler: src/handlers/promotions.get_promotions_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/promotions
          method: get

  createPromotion:
    handler: src/handlers/promotions.create_promotion_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/promotions
          method: post

  validatePromoCode:
    handler: src/handlers/promotions.validate_promo_code_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/promotions/validate
          method: post

  applyPromotion:
    handler: src/handlers/promotions.apply_promotion_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/promotions/apply
          method: post

  getActivePromotions:
    handler: src/handlers/promotions.get_active_promotions_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/promotions/active
          method: get

  # ==================== CUSTOMERS ====================
  getCustomerProfile:
    handler: src/handlers/customers.get_customer_profile_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/customers/{customerId}/profile
          method: get

  updateCustomerProfile:
    handler: src/handlers/customers.update_customer_profile_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/customers/{customerId}/profile
          method: put

  getCustomerFavorites:
    handler: src/handlers/customers.get_favorites_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/customers/{customerId}/favorites
          method: get

  addCustomerFavorite:
    handler: src/handlers/customers.add_favorite_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/customers/{customerId}/favorites
          method: post

  getCustomerAddresses:
    handler: src/handlers/customers.get_addresses_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/customers/{customerId}/addresses
          method: get

  addCustomerAddress:
    handler: src/handlers/customers.add_address_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/customers/{customerId}/addresses
          method: post

  trackOrder:
    handler: src/handlers/customers.track_order_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}/track
          method: get

  reorder:
    handler: src/handlers/customers.reorder_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}/reorder
          method: post

  # ==================== REPORTS ====================
  getSalesReport:
    handler: src/handlers/reports.get_sales_report_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/reports/sales
          method: get

  getOrdersReport:
    handler: src/handlers/reports.get_orders_report_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/reports/orders
          method: get

  getDailyReport:
    handler: src/handlers/reports.get_daily_report_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/reports/daily
          method: get

  # ==================== RATINGS ====================
  createOrderRating:
    handler: src/handlers/ratings.create_order_rating_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}/rating
          method: post

  getOrderRating:
    handler: src/handlers/ratings.get_order_rating_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}/rating
          method: get

  getTenantRatings:
    handler: src/handlers/ratings.get_tenant_ratings_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/ratings
          method: get

  createMenuItemReview:
    handler: src/handlers/ratings.create_menu_item_review_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/menu/{itemId}/reviews
          method: post

  getMenuItemReviews:
    handler: src/handlers/ratings.get_menu_item_reviews_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/menu/{itemId}/reviews
          method: get

  # ==================== LOCATIONS ====================
  createLocation:
    handler: src/handlers/locations.create_location_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/locations
          method: post

  getLocations:
    handler: src/handlers/locations.get_locations_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/locations
          method: get

  getLocation:
    handler: src/handlers/locations.get_location_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/locations/{locationId}
          method: get

  findNearbyLocations:
    handler: src/handlers/locations.find_nearby_locations_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/locations/nearby
          method: get

  checkDeliveryAvailability:
    handler: src/handlers/locations.check_delivery_availability_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/locations/check-delivery
          method: post

  # ==================== PAYMENTS ====================
  processPayment:
    handler: src/handlers/payments.process_payment_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}/payment
          method: post

  getOrderPayments:
    handler: src/handlers/payments.get_order_payments_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}/payments
          method: get

  getPaymentMethods:
    handler: src/handlers/payments.get_payment_methods_handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/payment-methods
          method: get

  # ==================== SQS EVENT HANDLERS ====================
  processOrderQueue:
    handler: src/handlers/queue.process_order_queue_handler
    events:
      - sqs:
          arn: !GetAtt OrdersQueue.Arn
          batchSize: 1

  # ==================== EVENTBRIDGE HANDLERS ====================
  orderEventHandler:
    handler: src/handlers/events.order_events_handler
    events:
      - eventBridge:
          eventBus: !Ref OrderEventBus
          pattern:
            source:
              - kfc.orders

  # ==================== SNS NOTIFICATION HANDLER ====================
  notificationHandler:
    handler: src/handlers/notifications.notification_handler
    events:
      - sns:
          arn: !Ref NotificationsTopic
          topicName: kfc-notifications-${self:provider.stage}

resources:
  Resources:
    # ==================== DYNAMODB TABLES ====================
    OrdersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.ORDERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    ConnectionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.CONNECTIONS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: connectionId
            AttributeType: S
          - AttributeName: tenantId
            AttributeType: S
        KeySchema:
          - AttributeName: connectionId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: TenantIndex
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    TenantsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.TENANTS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH

    MenuTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.MENU_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE

    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.USERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    InventoryTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.INVENTORY_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE

    PromotionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.PROMOTIONS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE

    CustomersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.CUSTOMERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE

    # ==================== SQS QUEUES ====================
    OrdersDeadLetterQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: kfc-orders-dlq-${self:provider.stage}
        MessageRetentionPeriod: 1209600

    OrdersQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: kfc-orders-queue-${self:provider.stage}
        VisibilityTimeout: 60
        MessageRetentionPeriod: 86400
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt OrdersDeadLetterQueue.Arn
          maxReceiveCount: 3

    # ==================== SNS TOPICS ====================
    NotificationsTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: kfc-notifications-${self:provider.stage}

    # ==================== EVENTBRIDGE ====================
    OrderEventBus:
      Type: AWS::Events::EventBus
      Properties:
        Name: ${self:provider.environment.ORDER_EVENTS_BUS}

    # ==================== S3 BUCKET ====================
    AssetsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: kfc-assets-${self:provider.stage}-595645243021
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders:
                - "*"
              AllowedMethods:
                - GET
                - PUT
                - POST
              AllowedOrigins:
                - "*"
              MaxAge: 3000

  Outputs:
    HttpApiEndpoint:
      Description: "HTTP API Endpoint"
      Value: !Sub "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com"

    WebSocketApiEndpoint:
      Description: "WebSocket API Endpoint"
      Value: !Sub
        - "wss://${WebsocketsApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}"
        - Stage: ${self:provider.stage}

    OrdersTableName:
      Value: !Ref OrdersTable

    OrdersQueueUrl:
      Value: !Ref OrdersQueue

    NotificationsTopicArn:
      Value: !Ref NotificationsTopic

    EventBusName:
      Value: !Ref OrderEventBus

    AssetsBucketName:
      Value: !Ref AssetsBucket
